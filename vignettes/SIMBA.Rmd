---
title: "SIMBA: name"
author:
- name: Simone Tiberi
  affiliation:
  - Department of Statistical Sciences, University of Bologna, Bologna, Italy
  email: simone.tiberi@unibo.it
- name: Jordy Bollon
  affiliation: 
  - Research Center dedicated to Personalized, Preventive and Predictive Medicine (CMP3VDA), Computational Department, Aosta, Italy
  email: jordy.bollon@iit.it
package: "`r BiocStyle::pkg_ver('SIMBA')`"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
bibliography: References.bib
vignette: >
  %\VignetteIndexEntry{SIMBA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
header-includes: 
- \usepackage{csquotes}
output: 
  BiocStyle::html_document
---

---
```{r setup, echo=FALSE, results="hide"}
knitr::opts_chunk$set(tidy=FALSE, cache=TRUE,
                      dev="png",
                      message=TRUE, error=FALSE, warning=TRUE)
```

# Introduction
*SIMBA* is a Bayesian method to perform inference on single protein isoforms (PIs).
Our approach infers the presence/absence of PIs, and also estimates their abundance;
additionally, it provides a measure of the uncertainty of these estimates, via:
i) the posterior probability the a protein isoform is present in the sample;
ii) a posterior credible interval of its abundance.
*SIMBA* inputs liquid cromatography mass spectrometry (MS) data, and can work with both Peptide-Spectrum Match (PSM) counts, and intensities.
When available, trascript isoform abundances (i.e., TPMs) are also incorporated:
TPMs are used to formulate an informative prior for the respective protein isoform relative abundance.
We further identify isoforms where the relative abundance of proteins and transcripts significantly differ.
We use a two-layer latent variable approach to model two sources of uncertainty typical of MS data:
i) peptides may be erroneously detected (even when absent);
ii) many peptides are compatible with multiple protein isoforms.
In the first layer, we sample the presence/absence of each peptide based on its estimated probability 
of being mistakenly detected, also known as PEP.
In the second layer, for peptides that were estimated as being present, 
we allocate their abundance across the PIs they map to.
These two steps allow us to recover the presence and abundance of each protein isoform.

## Bioconductor installation
*SIMBA* is available on [Bioconductor](https://bioconductor.org/packages/SIMBA) and can be installed with the command:
```{r Bioconductor_installation, eval=FALSE}
if (!requireNamespace("BiocManager", quietly=TRUE))
  install.packages("BiocManager")
BiocManager::install("SIMBA")
```

To access the R code used in the vignettes, type:
```{r vignettes, eval=FALSE} 
browseVignettes("SIMBA")
```

# Questions, issues and citation
Questions relative to *SIMBA* should be reported as a new issue at *[BugReports](https://github.com/SimoneTiberi/SIMBA/issues)*.

To cite *SIMBA*, type:
```{r citation} 
citation("SIMBA")
```

# Load the package
Load *SIMBA*.
```{r load, message=FALSE}
library(SIMBA)
```

# Input data and parameters
To start using *SIMBA*, we need to load and process the input data using the `load_data` function. We can use *MetaMorpheus* (MM) [@MetaMorpheus], or *OpenMS* Toolkit [@OpenMS] to create the data that need to be inputted. Other tools can be used as well, as long as the input files 
follow the structure mentioned in the [From user data](#from-user-data) Section.

A few additional data can be integrated in the model. First, if they are available, the abundances of transcript isoforms (TPMs) can be inputted to enhance protein isoforms inference. To correctly match proteomics and transcriptomics data, we must ensure that the names of the transcript isoforms are consistent with those of the PIs.
Then, if the Peptide Error Probability (PEP) is provided, the algorithm will sample the presence/absence of each peptide based on its PEP in order to propagate the peptide identification uncertainty throughout the inference process. Alternatively, unreliable peptides can be discarded before running the model by False Discovery Rate (FDR) filtering.

In this tutorial, we use a small dataset created by *MetaMorpheus*. The code to create it can be found [here](https://github.com/SimoneTiberi/SIMBA/blob/main/inst/script/extdata.Rmd). We start by setting the directory of the data (internal in the package):
```{r specify extdata path}
data_dir = system.file("extdata", package = "SIMBA")
```

## From *MetaMorpheus* Tool
We define a string with the path to the AllPeptides.psmtsv file returned by *MetaMorpheus*:
```{r set path MM psm}
path_to_peptides_psm = paste0(data_dir, "/AllPeptides.psmtsv")
```

### Peptide-Spectrum Match (PSM) counts
The AllPeptides.psmtsv file contains all the information required to run *SIMBA* with PSM counts. To load the file run:
```{r load psm}
data_loaded = load_data(path_to_peptides_psm = path_to_peptides_psm)
```

### Intensities
If we want to run the algorithm with peptide intensities, in addition to AllPeptides.psmtsv, we need to load a second file generated by MM: AllQuantifiedPeptides.tsv. Next, we need to make sure that the argument `abundance_type` is set to "intensities" . If not, the \code{load_data} function will ignore the AllQuantifiedPeptides.tsv file.
```{r set path MM intensities}
path_to_peptides_intensities = paste0(data_dir, "/AllQuantifiedPeptides.tsv")
data_loaded = load_data(path_to_peptides_psm = path_to_peptides_psm,
                        path_to_peptides_intensities = path_to_peptides_intensities,
                        abundance_type = "intensities")
```

## From *Percolator* (*OpenMS* Toolkit)
*SIMBA* is also compatible with the PSM file from *Percolator* [@Percolator]. Clicking on the following [link](https://github.com/SimoneTiberi/SIMBA/tree/main#readme) will lead you to a pipeline that uses *OpenMS* tools to generate an idXML file containing PSM data. Once the file is created, we just need to pass the file path to the \code{load_data} function and set `input_type` as "openMS" .
```{r set path OpenMS, eval = FALSE}
data_loaded = load_data(path_to_peptides_psm = "/path/to/file.idXML",
                        input_type = "openMS")
```
Please note that when using data generated by *Percolator*, the algorithm can only process PSM counts and not intensities. Additionally, the `FDR_thd` option is not considered. FDR filtering should be performed during the [data generation](https://github.com/SimoneTiberi/SIMBA/tree/main#readme).

## From user data
We can also input data coming from any bioinformatics tool. To this aim, the data must be organized in a tsv file where each raw corresponds to an identified peptide with four fields:

* 'Y': a numeric variable indicating the peptide abundance;
* 'EC': Equivalent Classes, a character string indicating the isoform(s) name the peptide maps to. If the peptide maps to multiple protein isoforms, the names must be separated with "|" , i.e. "name_isoform_1|name_isoform_2";
* 'PEP': (optional) a numeric variable indicating the Peptide Error Probability;
* 'sequence': (required with PEP) a character string indicating the peptide name/id/amino acids sequence.

Please remember that when using user data, the options `abundance_type`, `FDR_thd`, and `path_to_peptides_intensities` are not considered.

To load the tsv file with user data, we just need to pass the file path and set `input_type` as "other" .
```{r set path user, eval = FALSE}
data_loaded = load_data(path_to_peptides_psm = "/path/to/user_data.tsv",
                        input_type = "other")
```

## Parameters setting
To load TPMs data, we specify the path to the TPMs file. The format file must be a tsv with two fields for each isoform, i.e.:

* 'isoname': a character string indicating the isoform name;
* 'tpm': a numeric variable indicating the TPM counts.
```{r set path mRNA}
tpm_path = paste0(data_dir, "/jurkat_isoform_kallisto.tsv")
data_loaded = load_data(path_to_peptides_psm = path_to_peptides_psm,
                        path_to_tpm = tpm_path)
```

By default *SIMBA* takes into account Peptide Error Probability. If we want to disable the PEP integration, we just need to set the `PEP` option as `FALSE`. Additionally, without PEP, we can filter out unreliable peptides by setting the FDR threshold.
```{r with PEP, eval = FALSE}
data_loaded = load_data(path_to_peptides_psm = path_to_peptides_psm,
                        PEP = FALSE, FDR_thd = 0.01)
```

# Run *SIMBA* algorithm
Once we have loaded the data, we can run the algorithm using the `inference` function.
```{r inference, eval = FALSE}
set.seed(169612)
results = inference(data_loaded)
```

By default, *SIMBA* exploits one single core. To speed up the execution time, we can increase the number of cores by setting the `n_cores` argument.

## Gene Normalization
In order to analyse alternative splicing within a specific gene, we may want to normalize the estimated relative abundances for each set of protein isoforms that maps to a gene. To this aim, we need to input a csv file containing two columns denoting the isoform name and the gene name.
```{r default inference}
path_to_map_iso_gene = paste0(data_dir, "/map_iso_gene.csv")
set.seed(169612)
results_normalized = inference(data_loaded, map_iso_gene = path_to_map_iso_gene)
```

# Plotting the results
Finally, *SIMBA* provides the `plot_relative_abundances` function to visualize differential relative abundances between transcriptomics and
proteomics isoforms within a specific gene:
```{r plotting results}
plot_relative_abundances(results_normalized, gene_id = "TUBB")
```

By default `plot_relative_abundances` normalizes the relative abundances. To disable the normalization, we just need to set as `FALSE` the
`normalize_gene` argument.
```{r plotting results no normalization}
plot_relative_abundances(results_normalized, gene_id = "TUBB", normalize_gene = F)
```

Please note that `plot_relative_abundances` properly works because, before running the `inference` function, we provided a csv file that maps all the protein isoforms to the corresponding gene.

# Session info
```{r sessionInfo}
sessionInfo()
```

# References